# PocketBase Zod Migration Package

`pocketbase-zod-schema`.


## Structure

- `src/` - TypeScript source code
- `dist/` - Built output (generated by tsup)
- `package.json` - Package configuration and dependencies
- `tsconfig.json` - TypeScript configuration
- `tsup.config.ts` - Build configuration
- `vitest.config.ts` - Test configuration
- `.prettierrc` - Code formatting configuration
- `nodemon.json` - Development server configuration
- `.npmignore` - Files to exclude from npm package

## Installation (NPM)

```bash
npm install pocketbase-zod-schema
# or
yarn add pocketbase-zod-schema
# or
pnpm add pocketbase-zod-schema
```

## Usage

### CLI (`pocketbase-migrate`)

The package ships a CLI named `pocketbase-migrate`.

```bash
# generate migrations from schema changes
npx pocketbase-migrate generate

# show migration status without writing files
npx pocketbase-migrate status

# force generation even if destructive changes are detected
npx pocketbase-migrate generate --force
```

### Configuration

Create a `pocketbase-migrate.config.js` at your project root:

```js
export default {
  schema: {
    directory: "./src/schema",
    exclude: ["*.test.ts", "*.spec.ts"],
  },
  migrations: {
    directory: "./pocketbase/pb_migrations",
    format: "js",
  },
  diff: {
    warnOnDelete: true,
    requireForceForDestructive: true,
  },
};
```

### Defining schemas (Zod)

```ts
import { z } from "zod";
import { baseSchema, withPermissions } from "pocketbase-zod-schema/schema";

export const UserInputSchema = z.object({
  name: z.string().min(1),
  email: z.string().email(),
  avatar: z.string().optional(),
  role: z.enum(["user", "admin"]).default("user"),
});

export const UserSchema = withPermissions(
  baseSchema.extend(UserInputSchema.shape),
  {
    listRule: '@request.auth.id != ""',
    viewRule: '@request.auth.id != ""',
    createRule: "",
    updateRule: "@request.auth.id = id",
    deleteRule: "@request.auth.id = id",
  }
);
```

### Programmatic usage

```ts
import {
  parseSchemaFiles,
  compare,
  generate,
  loadSnapshotIfExists,
} from "pocketbase-zod-schema/migration";

const migrationsDir = "./pocketbase/pb_migrations";

const currentSchema = await parseSchemaFiles("./src/schema");
const previousSnapshot = loadSnapshotIfExists({ migrationsPath: migrationsDir });

const diff = compare(currentSchema, previousSnapshot);
const migrationPath = generate(diff, migrationsDir);
console.log({ migrationPath });
```

## Development (repo contributors)

From the root directory, you can run:

```bash
# Build the package
yarn build

# Run tests
yarn test

# Start development mode
yarn dev

# Format code
yarn format

# Lint code
yarn lint
```

All commands are proxied through the root package.json to this workspace.

## Publishing

Publishing is handled by GitHub Actions (Release Please).
